<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>퀵메모 작성 및 관리</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap');
  body {
    margin:0; padding:20px;
    font-family:'Nanum Gothic', sans-serif;
    background: linear-gradient(135deg, #1c1c2b, #28313b);
    color:#f0e6d2;
    min-height: 100vh;
  }
  h2 {
    text-align: center;
    color: #ffeb3b;
    text-shadow: 0 0 8px #ffd54f;
  }
  #quickmemoSearch {
    width: 100%;
    max-width: 600px;
    padding: 10px;
    font-size: 1.1rem;
    border-radius: 12px;
    border: none;
    outline: none;
    margin: 20px auto;
    display: block;
    box-shadow: 0 0 10px #ffc107aa inset;
    background: #222;
    color: #eee;
  }
  #quickmemoList {
    max-width: 600px;
    margin: 0 auto;
    background: #222;
    border-radius: 14px;
    box-shadow: 0 0 25px #ffc107cc;
    padding: 12px;
    max-height: 300px;
    overflow-y: auto;
  }
  .quickmemo-item {
    padding: 12px 16px;
    margin-bottom: 8px;
    background: #333;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease, border-left 0.3s ease;
  }
  .quickmemo-item:hover {
    background: #444;
  }
  .quickmemo-item.selected {
    background-color: #ffeb3b;
    color: #222;
    font-weight: 700;
    border-left: 6px solid #fbc02d;
  }
  #sermonContent {
    width: 100%;
    max-width: 600px;
    margin: 20px auto 10px;
    padding: 16px;
    font-size: 1.1rem;
    border-radius: 14px;
    border: none;
    resize: vertical;
    min-height: 140px;
    box-shadow: 0 0 20px #ffc107cc inset;
    background: #1e1e2a;
    color: #eee;
    outline: none;
    display: block;
  }
  .btn-row {
    max-width: 600px;
    margin: 0 auto 40px;
    display: flex;
    gap: 14px;
    justify-content: center;
    flex-wrap: wrap;
  }
  button {
    background: #ffea00;
    color: #222;
    border: none;
    border-radius: 16px;
    padding: 14px 28px;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(253,216,53,0.8);
    transition: background-color 0.3s ease, transform 0.15s ease;
  }
  button:hover {
    background-color: #fff176;
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.95);
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  @media (max-width: 480px) {
    #sermonContent {
      font-size: 1rem;
      min-height: 120px;
    }
    button {
      padding: 12px 20px;
      font-size: 1rem;
    }
  }
</style>
</head>
<body>

<h2>✍ 퀵메모 작성 및 관리</h2>

<input type="text" id="quickmemoSearch" placeholder="퀵메모 검색..." autocomplete="off" />

<div id="quickmemoList"></div>

<textarea id="sermonContent" placeholder="여기에 내용을 입력하세요..."></textarea>

<div class="btn-row">
  <button id="startRecordBtn">🎙 음성 녹음 시작</button>
  <button id="stopRecordBtn" disabled>■ 녹음 중지</button>
  <button id="editBtn">수정하기</button>
  <button id="saveBtn">저장하기</button>
</div>

<script>
  const quickmemoSearchInput = document.getElementById('quickmemoSearch');
  const quickmemoList = document.getElementById('quickmemoList');
  const sermonContent = document.getElementById('sermonContent');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const startRecordBtn = document.getElementById('startRecordBtn');
  const stopRecordBtn = document.getElementById('stopRecordBtn');

  let quickmemos = JSON.parse(localStorage.getItem('quickmemos') || '["하나님의 은혜는 무한합니다.","믿음은 시련을 견디게 합니다.","사랑은 모든 것을 이깁니다."]');

  let selectedIndex = null;

  function renderList(list) {
    quickmemoList.innerHTML = "";
    list.forEach((item, idx) => {
      const div = document.createElement("div");
      div.textContent = item;
      div.className = "quickmemo-item";
      if (idx === selectedIndex) div.classList.add("selected");
      div.dataset.idx = idx;
      quickmemoList.appendChild(div);
    });
  }

  quickmemoList.addEventListener("click", (e) => {
    if (e.target && e.target.dataset.idx !== undefined) {
      selectedIndex = Number(e.target.dataset.idx);
      renderList(quickmemos);
      sermonContent.value = quickmemos[selectedIndex];
    }
  });

  editBtn.addEventListener("click", () => {
    if (selectedIndex === null) {
      alert("수정할 퀵메모를 선택해주세요.");
      return;
    }
    sermonContent.value = quickmemos[selectedIndex];
  });

  saveBtn.addEventListener("click", () => {
    const newText = sermonContent.value.trim();
    if (!newText) {
      alert("내용을 입력해주세요.");
      return;
    }

    if (selectedIndex === null) {
      // 새 메모 추가 시 최대 5개 제한
      if (quickmemos.length >= 5) {
        alert("퀵메모는 최대 5개까지만 저장할 수 있습니다.");
        return;
      }
      quickmemos.push(newText);
      selectedIndex = quickmemos.length - 1;
    } else {
      // 기존 메모 수정
      quickmemos[selectedIndex] = newText;
    }

    renderList(quickmemos);
    localStorage.setItem('quickmemos', JSON.stringify(quickmemos));

    alert("퀵메모가 저장되었습니다.");
  });

  quickmemoSearchInput.addEventListener("input", () => {
    const keyword = quickmemoSearchInput.value.trim();
    if (keyword.length > 0) {
      const filtered = quickmemos.filter(qm => qm.includes(keyword));
      selectedIndex = null;
      sermonContent.value = "";
      renderList(filtered);
    } else {
      selectedIndex = null;
      sermonContent.value = "";
      renderList(quickmemos);
    }
  });

  // 음성 인식 설정 및 이벤트 처리
  let recognition;
  let isRecording = false;
  let recognizedText = '';

  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.lang = 'ko-KR'; // 한국어 설정
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onstart = () => {
      isRecording = true;
      startRecordBtn.disabled = true;
      stopRecordBtn.disabled = false;
    };

    recognition.onerror = (event) => {
      console.error('음성 인식 오류:', event.error);
      alert('음성 인식 중 오류가 발생했습니다: ' + event.error);
      stopRecording();
    };

    recognition.onresult = (event) => {
      let interimTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
          recognizedText += event.results[i][0].transcript;
        } else {
          interimTranscript += event.results[i][0].transcript;
        }
      }
      sermonContent.value = recognizedText + interimTranscript;
    };

    recognition.onend = () => {
      isRecording = false;
      startRecordBtn.disabled = false;
      stopRecordBtn.disabled = true;

      if (recognizedText.trim().length > 0) {
        if (quickmemos.length >= 5) {
          alert("퀵메모는 최대 5개까지만 저장할 수 있습니다.");
          return;
        }
        selectedIndex = quickmemos.length;
        quickmemos.push(recognizedText.trim());
        renderList(quickmemos);
        sermonContent.value = recognizedText.trim();

        alert('녹음이 완료되었습니다. 저장 버튼을 눌러주세요.');
      }
    };
  } else {
    alert('이 브라우저는 음성 인식을 지원하지 않습니다.');
    startRecordBtn.disabled = true;
    stopRecordBtn.disabled = true;
  }

  function startRecording() {
    recognizedText = '';
    recognition.start();
  }

  function stopRecording() {
    recognition.stop();
  }

  startRecordBtn.addEventListener('click', startRecording);
  stopRecordBtn.addEventListener('click', stopRecording);

  renderList(quickmemos);
</script>

</body>
</html>
